<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Arturo Torres Ortiz">
<meta name="dcterms.date" content="2026-02-24">

<title>Assignment 3: Variant consequence annotation – TRGN-515</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-8b4baf804e461d9b72633f0de59a0cac.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-38685b6e60ad7588714dbe24fc7031b2.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">TRGN-515</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../modules.html"> 
<span class="menu-text">Modules</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/trgn-515"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../modules/3_annotation/3_annotation.html">Module 3: Variant functional annotation</a></li><li class="breadcrumb-item"><a href="../../modules/3_annotation/3_annotation.html">Assignment 3: Variant consequence annotation</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 0: Sequencing technologies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../modules/0_intro_git/0_intro_git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Module 0: Git and GitHub</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 1: Sequencing technologies</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../modules/1_sequencing_techs/1_sequencing_techs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 1: Next Generation Sequencing Technologies</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 2: Structural Variants</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../modules/2_sv/2_sv.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Assignment 2: Structural variants</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Module 3: Variant functional annotation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../modules/3_annotation/3_annotation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Assignment 3: Variant consequence annotation</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives">Learning objectives</a></li>
  <li><a href="#dataset-1-antimicrobial-resistance-in-mycobacterium-tuberculosis" id="toc-dataset-1-antimicrobial-resistance-in-mycobacterium-tuberculosis" class="nav-link" data-scroll-target="#dataset-1-antimicrobial-resistance-in-mycobacterium-tuberculosis">Dataset 1: Antimicrobial resistance in <em>Mycobacterium tuberculosis</em></a>
  <ul>
  <li><a href="#input-and-outputs" id="toc-input-and-outputs" class="nav-link" data-scroll-target="#input-and-outputs">Input and outputs</a></li>
  <li><a href="#required-software" id="toc-required-software" class="nav-link" data-scroll-target="#required-software">Required software</a></li>
  <li><a href="#slurm-arrays" id="toc-slurm-arrays" class="nav-link" data-scroll-target="#slurm-arrays">SLURM arrays</a></li>
  <li><a href="#short-read-alignment" id="toc-short-read-alignment" class="nav-link" data-scroll-target="#short-read-alignment">Short-read alignment</a>
  <ul class="collapse">
  <li><a href="#task-1-complete-the-mapping-and-variant-calling-pipeline-for-m.-tuberculosis." id="toc-task-1-complete-the-mapping-and-variant-calling-pipeline-for-m.-tuberculosis." class="nav-link" data-scroll-target="#task-1-complete-the-mapping-and-variant-calling-pipeline-for-m.-tuberculosis.">Task 1: Complete the mapping and variant calling pipeline for <em>M. tuberculosis</em>.</a></li>
  </ul></li>
  <li><a href="#multi-sample-vcf-files" id="toc-multi-sample-vcf-files" class="nav-link" data-scroll-target="#multi-sample-vcf-files">Multi-sample VCF files</a>
  <ul class="collapse">
  <li><a href="#task-2-merge-the-vcf-files-from-the-t85-strain-and-the-cdc-strain." id="toc-task-2-merge-the-vcf-files-from-the-t85-strain-and-the-cdc-strain." class="nav-link" data-scroll-target="#task-2-merge-the-vcf-files-from-the-t85-strain-and-the-cdc-strain.">Task 2: Merge the VCF files from the T85 strain and the CDC strain**.</a></li>
  </ul></li>
  <li><a href="#filtering-low-complexity-regions" id="toc-filtering-low-complexity-regions" class="nav-link" data-scroll-target="#filtering-low-complexity-regions">Filtering low complexity regions</a>
  <ul class="collapse">
  <li><a href="#task-3-removing-variants-that-fall-within-hypervariable-regions." id="toc-task-3-removing-variants-that-fall-within-hypervariable-regions." class="nav-link" data-scroll-target="#task-3-removing-variants-that-fall-within-hypervariable-regions.">Task 3: Removing variants that fall within hypervariable regions.</a></li>
  </ul></li>
  <li><a href="#variant-functional-annotation" id="toc-variant-functional-annotation" class="nav-link" data-scroll-target="#variant-functional-annotation">Variant functional annotation</a>
  <ul class="collapse">
  <li><a href="#task-4-variant-annotation-file" id="toc-task-4-variant-annotation-file" class="nav-link" data-scroll-target="#task-4-variant-annotation-file">Task 4: Variant annotation file</a>
  <ul class="collapse">
  <li><a href="#vep" id="toc-vep" class="nav-link" data-scroll-target="#vep">VEP</a></li>
  <li><a href="#bcftools-csq" id="toc-bcftools-csq" class="nav-link" data-scroll-target="#bcftools-csq">BCFtools csq</a></li>
  <li><a href="#snpeff" id="toc-snpeff" class="nav-link" data-scroll-target="#snpeff">SnpEff</a></li>
  </ul></li>
  <li><a href="#task-5-variant-functional-annotation" id="toc-task-5-variant-functional-annotation" class="nav-link" data-scroll-target="#task-5-variant-functional-annotation">Task 5: Variant functional annotation</a>
  <ul class="collapse">
  <li><a href="#variant-consequence" id="toc-variant-consequence" class="nav-link" data-scroll-target="#variant-consequence">Variant consequence</a></li>
  </ul></li>
  <li><a href="#task-6-parse-required-information-from-vcf-files" id="toc-task-6-parse-required-information-from-vcf-files" class="nav-link" data-scroll-target="#task-6-parse-required-information-from-vcf-files">Task 6: Parse required information from VCF files</a></li>
  <li><a href="#task-7-detect-variants-likely-to-be-associated-to-rifampicin-resistance." id="toc-task-7-detect-variants-likely-to-be-associated-to-rifampicin-resistance." class="nav-link" data-scroll-target="#task-7-detect-variants-likely-to-be-associated-to-rifampicin-resistance.">Task 7: Detect variants likely to be associated to rifampicin resistance.</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="3_annotation.pdf"><i class="bi bi-file-pdf"></i>PDF</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../modules/3_annotation/3_annotation.html">Module 3: Variant functional annotation</a></li><li class="breadcrumb-item"><a href="../../modules/3_annotation/3_annotation.html">Assignment 3: Variant consequence annotation</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Assignment 3: Variant consequence annotation</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Arturo Torres Ortiz </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">February 24, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Functional annotation of variants involve predicting the potential functional impact of a genetic variant on a gene or protein. Common annotations include the variant consequence (synonymous, non-synonymous), the variant status (pathogenic, non-pathogenic, uncertain, etc), its location (intron, exon, TTS, etc.), aminoacid location and change, etc.</p>
<p>In this module, we will use 2 datasets:</p>
<ol type="1">
<li>A microbial dataset to find variants associated to antimicrobial resistance</li>
<li>A human dataset to annotate variants and understand their clinical consequence</li>
</ol>
<section id="learning-objectives" class="level1">
<h1>Learning objectives</h1>
<p>At the end of this week’s assessment you will be able to:</p>
<ol type="1">
<li>Annotate variants</li>
<li>Understand the functional annotation of genetic variants</li>
<li>Scan for putative variants of interest given their functional annotation</li>
<li>Visualize variants and alignments</li>
</ol>
</section>
<section id="dataset-1-antimicrobial-resistance-in-mycobacterium-tuberculosis" class="level1">
<h1>Dataset 1: Antimicrobial resistance in <em>Mycobacterium tuberculosis</em></h1>
<p>For this first dataset, we will analyze Illumina short-read sequencing data from a laboratory experimental evolution project. Experimental evolution or experimental mutagenesis studies aim to evolve microbial traits of interest in a controlled laboratory environment by growing populations over multiple generations under different conditions. Typically, the starting population will have a known phenotype (and often genotype), to study adaptation over generations in response to different selective preassures. For this experiment, our organism is <em>Mycobacterium tuberculosis</em>, and the phenotype evolved is antimicrobial resistance, especifically resistance to rifampicin, a common first line antibiotic that is essential for tuberculosis treatment.</p>
<p>The dataset contains two different lineages. Starting from a rifampicin susceptible strain, three different populations from each lieneage are grown in the presence of rifampicin. Two susceptible strains of each lineage are grown in parallel as control (CDC1551E and T85E). At the end of the growth period, all strains underwent short-read Illumina whole-genome sequencing.</p>
<!-- Experimental evolution strain | M. tuberculosis lineage | Resistance             -->
<table class="caption-top table">
<colgroup>
<col style="width: 39%">
<col style="width: 31%">
<col style="width: 29%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th></th>
<th>Resistance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>CDC1551E</td>
<td>Lineage 4</td>
<td>pan‐susceptible</td>
</tr>
<tr class="even">
<td>CDC06E</td>
<td>Lineage 4</td>
<td>rifampin‐monoresistant</td>
</tr>
<tr class="odd">
<td>CDC47E</td>
<td>Lineage 4</td>
<td>rifampin‐monoresistant</td>
</tr>
<tr class="even">
<td>CDC07E</td>
<td>Lineage 4</td>
<td>rifampin‐monoresistant</td>
</tr>
<tr class="odd">
<td>T85E</td>
<td>Lineage 2</td>
<td>pan‐susceptible</td>
</tr>
<tr class="even">
<td>T8501E</td>
<td>Lineage 2</td>
<td>rifampin‐monoresistant</td>
</tr>
<tr class="odd">
<td>T8538E</td>
<td>Lineage 2</td>
<td>rifampin‐monoresistant</td>
</tr>
<tr class="even">
<td>T8505E</td>
<td>Lineage 2</td>
<td>rifampin‐monoresistant</td>
</tr>
</tbody>
</table>
<p>Using the strains grown in presence of rifampicin and those grown in standard culture as control, the main goal of this study is to detect mutations likely to be associated with rifampicin resistance.</p>
<p>More information about this data:</p>
<ul>
<li>Comas, I., Borrell, S., Roetzer, A. et al.&nbsp;Whole-genome sequencing of rifampicin-resistant Mycobacterium tuberculosis strains identifies compensatory mutations in RNA polymerase genes. Nat Genet 44, 106–110 (2012). https://doi.org/10.1038/ng.1038</li>
</ul>
<section id="input-and-outputs" class="level2">
<h2 class="anchored" data-anchor-id="input-and-outputs">Input and outputs</h2>
<p>The input for this assessment are the fastq files for all sequenced strains.</p>
<blockquote class="blockquote">
<p>Fastq files</p>
<p><code>/project2/msalomon_1816/trgn_515/3_annotation/m_tuberculosis/fastq</code></p>
</blockquote>
<blockquote class="blockquote">
<p>H37Rv hypervariable regions</p>
<p><code>/project2/msalomon_1816/trgn_515/3_annotation/m_tuberculosis/reference/mtb.h37rv.hypervariable.bed</code></p>
</blockquote>
<p>The final output will be a list of variants likely to be associated with rifampicin resistance.</p>
</section>
<section id="required-software" class="level2">
<h2 class="anchored" data-anchor-id="required-software">Required software</h2>
<p>In order to complete the assessment, the following tools need to be installed:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load bwa</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load htslib</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load bcftools</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load samtools</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load fastqc</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="slurm-arrays" class="level2">
<h2 class="anchored" data-anchor-id="slurm-arrays">SLURM arrays</h2>
<p>For this assignment we are going to work with multiple samples, applying the same commands to each of them, so it’s worth learning how to properly use SLURM arrays. Job arrays allow you to submit a single SLURM job script to launch many similar jobs. Since we will be running the same bioinformatic pipeline, array jobs are perfect for this task.</p>
<p>To submit an array job, you only need to add this line to the SLURM job <code>#SBATCH --array=N0-N1</code>, but changing N0 and N1 for your starting and ending number, respectively (eg: <code>#SBATCH --array=1-10</code> to run 10 jobs). The only thing that changes between each of the jobs in the array is the variable <code>SLURM_ARRAY_TASK_ID</code>, which takes the value of each iteration that you specified with <code>#SBATCH --array=1-10</code>. So in the first iteration, the variable <code>${SLURM_ARRAY_TASK_ID}</code> will have a value of 1, then of 2, 3 etc. So that variable is the only element that lets you change what happens in each iteration, so you need to use it in a smart way! We can use it to select specific files in a folder, or a specific line in a file. For instance:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --account=msalomon_1385</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --partition=main</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --nodes=1</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --ntasks=1</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=5G</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=1:00:00</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=fastqc</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --output=/scratch1/USER/temp/fastqc_%j.%a.out</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --error=/scratch1/USER/temp/fastqc_%j.%a.err</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=1-10</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Put the input and output directories into variables for conciseness</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="va">in_dir</span><span class="op">=</span>/project2/msalomon_1816/trgn_515/3_annotation/m_tuberculosis/fastq</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="va">out_dir</span><span class="op">=</span>/scratch1/USER/1_exp_evolution/fastq_qc</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="co"># First, let's select one file within a directory. In each iteration we will get a different file:</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="va">in_file</span><span class="op">=</span><span class="va">$(</span><span class="fu">ls</span> <span class="va">$in_dir</span>/ <span class="kw">|</span> <span class="fu">awk</span> <span class="st">"NR==</span><span class="va">${SGE_TASK_ID}</span><span class="st">"</span><span class="va">)</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="va">sample</span><span class="op">=</span><span class="va">$(</span><span class="fu">basename</span> <span class="va">$in_file</span> .fastq.gz<span class="va">)</span> <span class="co"># Set up a sample variable for the output.</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="ex">fastqc</span> <span class="at">-o</span> <span class="va">$out_dir</span>/<span class="va">$sample</span> <span class="at">--extract</span> <span class="at">--dir</span> <span class="va">$out_dir</span> <span class="va">$in_file</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>In this example, we are listing the files in our input directory using <code>ls</code>, then we are selecting each file depending on their order using <code>awk</code> and <code>${SGE_TASK_ID}</code>. So when <code>${SGE_TASK_ID}</code> is 1, we get the first file; when it’s 2, we get the second file, etc.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now let's use a file with sample ids in each line of the file</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="va">sample_list</span><span class="op">=</span>/scratch1/USER/1_exp_evolution/sample_list.txt</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="va">sample</span><span class="op">=</span><span class="va">$(</span><span class="fu">awk</span> <span class="st">"NR==</span><span class="va">${SGE_TASK_ID}</span><span class="st">"</span> <span class="va">$sample_list)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="va">in_file</span><span class="op">=</span><span class="va">$sample</span>.fastq.gz <span class="co"># Set up the file name variable.</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="ex">fastqc</span> <span class="at">-o</span> <span class="va">$out_dir</span>/<span class="va">$sample</span> <span class="at">--extract</span> <span class="at">--dir</span> <span class="va">$out_dir</span> <span class="va">$in_file</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>In this case, we directly have a list of sample ids that we use the array job to loop through.</p>
<p>There are many ways to build array jobs, and the way to structure it will depend on your specific application. Just remember, everything comes down to how you use the <code>${SGE_TASK_ID}</code> variable.</p>
<p>A couple of other interesting variables in the array header are <code>%j</code> and <code>%a</code>. The variable <code>%j</code> stores the job id, and the variable <code>%a</code> has the array index (1,2,3,…n), so each of the stderr and stdout outputs will have their own name.</p>
</section>
<section id="short-read-alignment" class="level2">
<h2 class="anchored" data-anchor-id="short-read-alignment">Short-read alignment</h2>
<p>To run any read mapping software, we first need a reference genome. In the previous assignments, the CARD server already had multiple human reference genomes for us to use. For <em>M. tuberculosis</em>, we need to get it ourselves. The most common reference genome for tuberculosis is H37Rv. The assembly name for this reference genome is ASM19595v2.</p>
<p>All modern mappers require building an index to easily parse the reference genome during mapping. In fact, some of the biggest speed and memory improvements over early mappers was thanks to improved indexing methods. BWA, for instance, is based on the Burrows-wheeler Transform for powerful indexing to quickly locate where a read might align within the reference genome. The indexing for BWA can be done with the following command:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bwa</span> index <span class="va">$ref_genome</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>That will create multiple files with the same name as your reference genome, but ending in different extensions. Those are the indexes. Keep those files with the same and location as your reference genome. If a software requires those indexes, you just need to show the location of the reference genome, and it will assume the name and location of all the indexes.</p>
<section id="task-1-complete-the-mapping-and-variant-calling-pipeline-for-m.-tuberculosis." class="level3">
<h3 class="anchored" data-anchor-id="task-1-complete-the-mapping-and-variant-calling-pipeline-for-m.-tuberculosis.">Task 1: Complete the mapping and variant calling pipeline for <em>M. tuberculosis</em>.</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Find the reference genome assembly ASM19595v2 in NCBI, download it, and fill in variable ref_genome in your mapping script <code>ref_genome=/path/to/reference</code></li>
<li>Index the reference genome</li>
<li>Perform QC in the raw reads</li>
<li>Prepare a <strong>SLURM array job</strong> to perform the entire mapping pipeline:
<ol type="1">
<li>Quality control and filtering</li>
<li>Mapping</li>
<li>Marking duplicates</li>
<li>Indel re-alignment</li>
<li>Variant calling</li>
<li>Variant soft-filtering</li>
<li>Index the vcf file (<code>tabix -p vcf &lt;input_file.vcf.gz&gt;</code>)</li>
</ol></li>
</ol>
<p>Attach your SLURM array job script as the answer to this question <strong>(20pts)</strong></p>
</div>
</div>
</section>
</section>
<section id="multi-sample-vcf-files" class="level2">
<h2 class="anchored" data-anchor-id="multi-sample-vcf-files">Multi-sample VCF files</h2>
<p>When comparing samples, we often use multi-sample VCF files. The file structure is the same as the single-sample files we have used in the previous modules, but now we will have multiple SAMPLE columns. This is useful for quickly comparing variants between samples, but it also save disk space and file number when dealing with many samples.</p>
<section id="task-2-merge-the-vcf-files-from-the-t85-strain-and-the-cdc-strain." class="level3">
<h3 class="anchored" data-anchor-id="task-2-merge-the-vcf-files-from-the-t85-strain-and-the-cdc-strain.">Task 2: Merge the VCF files from the T85 strain and the CDC strain**.</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Find the right <code>bcftools</code> tool to merge the 4 VCF files from each lineage, resulting in two VCF files with 4 samples each.</p>
<p><strong>NOTE:</strong> Remember to use the right flag within the command to remove non-pass variants!</p>
<ol type="1">
<li>Paste your variant merging command <strong>(5pts)</strong></li>
<li>Describe each column of the resulting VCF file. How does it differ from a single-sample VCF file? <strong>(5pts)</strong></li>
<li>Should we use the INFO column or the FORMAT column to filter specific samples? Why? <strong>(5pts)</strong></li>
</ol>
</div>
</div>
</section>
</section>
<section id="filtering-low-complexity-regions" class="level2">
<h2 class="anchored" data-anchor-id="filtering-low-complexity-regions">Filtering low complexity regions</h2>
<p>Low complexity regions are very hard to map correctly, especially when using short-reads. For that reason, often we remove any variants that fall within known regions.</p>
<p>If you don’t have a file with hypervariable regions, you can infer them! The most classic algorithm to do this is <code>DustMasker</code> from NCBI (https://www.ncbi.nlm.nih.gov/IEB/ToolBox/CPP_DOC/lxr/source/src/app/dustmasker/). There are faster implementations of the same algorithm. I can recommend Heng Li’s implementation <code>sdust</code>, which is available in the <code>minimap2</code> installation.</p>
<p>For this assignment, I have provided you with a file of hypervariable regions. Look at the path of file in the “Input and outputs” section.</p>
<p>There are many ways to remove variants that fall within specific genomic coordinates.</p>
<ol type="1">
<li>Hard filtering</li>
</ol>
<p>We can use <code>bcftools</code> for this. We can use the flag <code>-T</code>. Using it on its own will keep regions listed in the file. Using it with the symbol <code>^</code> will remove regions listed in the file.</p>
<p>Sometimes, to use <code>bcftools</code> and quickly jump between lines, we need to first compress and index both the VCF and the BED files. This is useful when using flags like <code>-r</code> or <code>-R</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compress and index the VCF</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bgzip</span> input.vcf</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">tabix</span> <span class="at">-p</span> vcf input.vcf.gz</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compress and index the BED file</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">bgzip</span> regions.bed</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="ex">tabix</span> <span class="at">-p</span> bed regions.bed.gz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>For the <code>-T</code> flag, bcftools actually reads the file line by line, so we don’t need to index it.</p>
<p>We can then use the <code>-T</code> flag with the <code>^</code> symbol in front of the region file:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> view <span class="at">-T</span> ^regions.bed input.vcf.gz <span class="at">-O</span> z <span class="at">-o</span> hard_filtered.vcf.gz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Another quick option if you want to avoid compressing and indexing file is using <code>bedtools</code>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bedtools</span> intersect <span class="at">-header</span> <span class="at">-v</span> <span class="at">-a</span> input.vcf <span class="at">-b</span> regions.bed <span class="op">&gt;</span> hard_filtered.vcf</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ol type="1">
<li>Soft filtering</li>
</ol>
<p>This is a bit more complex than hard filtering, since we are adding a conditional tag to the FILTER column.</p>
<p>First, we need to devine what our new tag is in the VCF header:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">'##FILTER=&lt;ID=hypervar,Description="Variant falls within a hypervariable region"&gt;'</span> <span class="op">&gt;</span> filter_header.txt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We can then use <code>bcftools annotate</code> to add that filter in the VCF file. We will use the <code>--mark-sites (-m)</code> flag to append the tag to the existing FILTER options. We will also use the <code>-h</code> flag to append the new FILTER header line to the existing header.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> annotate <span class="at">-a</span> regions.bed <span class="at">-h</span> filter_header.txt <span class="at">-m</span> <span class="st">'+hypervar'</span> input.vcf.gz <span class="at">-O</span> z <span class="at">-o</span> soft_filtered.vcf.gz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="task-3-removing-variants-that-fall-within-hypervariable-regions." class="level3">
<h3 class="anchored" data-anchor-id="task-3-removing-variants-that-fall-within-hypervariable-regions.">Task 3: Removing variants that fall within hypervariable regions.</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Hard-filtered the variants from your multi-sample VCF that fall within the hypervariable regions in the .bed file. Attach your command <strong>(5pts)</strong></li>
</ol>
</div>
</div>
</section>
</section>
<section id="variant-functional-annotation" class="level2">
<h2 class="anchored" data-anchor-id="variant-functional-annotation">Variant functional annotation</h2>
<p>Functional annotation of variants involve predicting the potential functional impact of a genetic variant on a gene or protein. Common annotations include the variant consequence (synonymous, non-synonymous), it’s location (intron, exon, TTS, etc.), aminoacid location and change, etc.</p>
<p>Variant functional consequence prediction typically requires an annotation file. This annotation file comes in a variety of formats and with varying information. The most used formats are GFF (General Feature Format) and GTF (Gene Transfer Format), where gene location and coordinates are the main source of information. These formats are pretty similar to the VCF format, and many fields will seem familiar.</p>
<section id="task-4-variant-annotation-file" class="level3">
<h3 class="anchored" data-anchor-id="task-4-variant-annotation-file">Task 4: Variant annotation file</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Find in NCBI and download the annotation file in GFF format for ASM19595v2, and fill in variable gff_file <strong>(5pts)</strong> <code>gff_file=/path/to/gff_file</code></li>
</ol>
</div>
</div>
<p>These annotation files sometimes come unsorted. To ensure proper formatting of the GFF file and to index it, we can use genometools with the following code:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate /project2/msalomon_1816/trgn_515/conda_env/genometools</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="ex">gt</span> gff3 <span class="at">-sort</span> <span class="at">-tidy</span> <span class="at">-retainids</span> input.gff <span class="kw">|</span> <span class="ex">bgzip</span> <span class="at">-c</span> <span class="op">&gt;</span> sorted.gff.gz</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="ex">tabix</span> index <span class="at">-p</span> gff sorted.gff.gz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Using genometools ensures proper formatting. GFF format stores genomic features (gene, mRNA, exon…). These features need to be ordered hierarchically, with parent features (e.g gene) preceding their child features (e.g mRNA, exon, CDS). Using genometools ensures that the GFF file is sorted by coordinate while respecting the hierarchical order.</p>
<p>We can also sort it using bedtools, but this won’t strictly enforce the hierarchical order of genomic features:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bedtools</span> sort <span class="at">-header</span> <span class="at">-i</span> input.gff <span class="kw">|</span> <span class="ex">bgzip</span> <span class="at">-c</span> <span class="op">&gt;</span> sorted.gff.gz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We can also use simple bash scripting, but this command will remove the header, which may cause problems with some tools:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">grep</span> <span class="at">-v</span> <span class="st">"#"</span> <span class="va">$gff_file</span> <span class="kw">|</span> <span class="fu">sort</span> <span class="at">-k1,1</span> <span class="at">-k4,4n</span> <span class="at">-k5,5n</span> <span class="at">-t</span><span class="st">$'</span><span class="dt">\t</span><span class="st">'</span> <span class="kw">|</span> <span class="ex">bgzip</span> <span class="at">-c</span> <span class="op">&gt;</span> <span class="va">$gff_file</span>.gz</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">tabix</span> <span class="at">-p</span> gff <span class="va">$gff_file</span>.gz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>There are many tools to perform variant annotation. Some of the most commonly used include <code>VEP</code> (Variant Effect Predictor, from Ensembl); <code>SnpEff</code>; <code>BCFtools csq</code>, or <code>ANNOVAR</code>. Ideally, we would like a simple software that takes a VCF file as an input, gives an annotated VCF file as output, and can be easily used with command pipes.</p>
<p>To use VEP, use the conda environment:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate /project2/msalomon_1816/trgn_515/conda_env/vep</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>For bcftools or SnpEff:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> activate /project2/msalomon_1816/trgn_515/conda_env/trgn515</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<section id="vep" class="level4">
<h4 class="anchored" data-anchor-id="vep">VEP</h4>
<p>VEP is a very popular choice as it’s one of the most comprehensive tools and it has a seamless integration with the Ensembl databases. It is, howver, one of the slowest softwares for variant annotation, so you should be careful when using it for large genomes (such as the human one).</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">vep</span> <span class="co"># Main call to VEP</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-i</span> <span class="op">&lt;</span>vcf_file<span class="kw">|</span><span class="ex">stdin</span><span class="op">&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-o</span> <span class="op">&lt;</span>vcf_file<span class="kw">|</span><span class="ex">stdout</span><span class="op">&gt;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ex">--gff</span> <span class="op">&lt;</span>gff_file<span class="op">&gt;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="ex">--fasta</span> <span class="op">&lt;</span>reference_genome<span class="op">&gt;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-distance</span> <span class="op">&lt;</span>n<span class="op">&gt;</span> <span class="co"># Include consequences in genes n basepairs upstream and downstream. Useful for variants in regulatory regions or terciary structures </span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="ex">--vcf</span> <span class="co"># Output in vcf format</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="ex">--compress_output</span> bgzip <span class="co"># Compress output</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="ex">--no_stats</span> <span class="co"># Do not report stats file</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="bcftools-csq" class="level4">
<h4 class="anchored" data-anchor-id="bcftools-csq">BCFtools csq</h4>
<p>As most bcftools tools, <code>BCFtools csq</code> is memory efficient and incredibly fast. Additionally, unlike most other tools, <code>BCFtools csq</code> predicts consequences within a genotype. That means that if a variant corrects another variant dowstream, the consequence of both variants will be reverted.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> csq</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">-f</span> <span class="op">&lt;</span>ref_genome<span class="op">&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="ex">-g</span> <span class="op">&lt;</span>gff_file<span class="op">&gt;</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="ex">-p</span> a <span class="co"># Handle unphased genotypes</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-Oz</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-o</span> <span class="op">&lt;</span>vcf_file<span class="kw">|</span><span class="ex">stdout</span><span class="op">&gt;</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>vcf_file<span class="kw">|</span><span class="ex">stdin</span><span class="op">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Unfortunately, <code>BCFtools csq</code> is very particular about the format of the GFF file, and it requires that the file adheres perfectly to the Ensembl format. That means that even files downloaded from NCBI may cause errors. For most Eukaryotic genomes, you can find GFF files on the Ensembl portal.</p>
</section>
<section id="snpeff" class="level4">
<h4 class="anchored" data-anchor-id="snpeff">SnpEff</h4>
<p><code>SnpEff</code> is another widely used variant prediction tool. The performance is slightly better than <code>VEP</code>, but a lot worse than <code>BCFtools csq</code>. However, in some cases it offers more detailed variant prediction.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">snpEff</span> eff</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>database_name<span class="op">&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>input_vcf_file<span class="kw">|</span><span class="ex">stdin</span><span class="op">&gt;</span> </span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>The database name for M. tuberculosis H37Rv is Mycobacterium_tuberculosis_h37rv. If your genome is not present in their standard databases, you can build your own, but this process is quite cumbersome.</p>
</section>
</section>
<section id="task-5-variant-functional-annotation" class="level3">
<h3 class="anchored" data-anchor-id="task-5-variant-functional-annotation">Task 5: Variant functional annotation</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Use one of VEP, bcftools, or SnpEff to annotate the variants from the multi-sample filtered VCF file <strong>(5pts)</strong></li>
</ol>
</div>
</div>
<section id="variant-consequence" class="level4">
<h4 class="anchored" data-anchor-id="variant-consequence">Variant consequence</h4>
<p>There can be many different types of variant consequences in our output. Some good resources to check what those consequences mean:</p>
<ul>
<li>https://useast.ensembl.org/info/genome/variation/prediction/predicted_data.html</li>
<li>http://sequenceontology.org/browser/current_svn/term/</li>
</ul>
<p>For easy visualizaiton of the results, it is a good idea to parse the VCF file into other formats.</p>
<p>The final data we need to finish the assignment is <strong>gene name</strong>, <strong>variant consequence</strong> and what <strong>samples</strong> that variant is present.</p>
<p>You can write a script to parse the VCF file and gather that information. For easy interpretation of results, let’s assume any position with heterozygous variants is subjected to sequencing errors. A quick way to do this within <code>bcftools</code> would be <code>bcftools query</code>.</p>
<p>For instance (considering output from VEP):</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span> <span class="op">&lt;(</span><span class="ex">bcftools</span> query <span class="at">-f</span> <span class="st">'%CHROM\t%POS\t%REF\t%ALT[\t%SAMPLE=%GT]\n'</span> CDC_all.vcf.gz<span class="op">)</span> <span class="op">&lt;(</span><span class="ex">bcftools</span> query <span class="at">-f</span> <span class="st">'%CSQ\n'</span> CDC_all.vcf.gz <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span> <span class="st">'|'</span> <span class="at">-f4,2</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="st">'|'</span> <span class="st">'\t'</span><span class="op">)</span> <span class="kw">|</span> <span class="fu">egrep</span> <span class="at">-v</span> <span class="st">"0/1"</span> <span class="op">&gt;</span> CDC_results.txt</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">paste</span> <span class="op">&lt;(</span><span class="ex">bcftools</span> query <span class="at">-f</span> <span class="st">'%CHROM\t%POS\t%REF\t%ALT[\t%SAMPLE=%GT]\n'</span> T85_all.vcf.gz<span class="op">)</span> <span class="op">&lt;(</span><span class="ex">bcftools</span> query <span class="at">-f</span> <span class="st">'%CSQ\n'</span> T85_all.vcf.gz <span class="kw">|</span> <span class="fu">cut</span> <span class="at">-d</span> <span class="st">'|'</span> <span class="at">-f4,2</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="st">'|'</span> <span class="st">'\t'</span><span class="op">)</span> <span class="kw">|</span> <span class="fu">egrep</span> <span class="at">-v</span> <span class="st">"0/1"</span> <span class="op">&gt;</span> T85E_results.txt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We can also use the bcftools plugin <code>bcftools +split-vep</code>. There are many plugins to bcftools. These are usually for specific tasks outside of the main bcftools functionality.</p>
<p>To use these plugins, you need to call them using the <code>+</code> sign in front of the plugin name. You can get a list of all available plugins using:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> plugin <span class="at">-l</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>We can use this plugin to select the features we want from the VCF file. For the VEP output:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> view <span class="at">-e</span> <span class="st">'GT="0/1"'</span> CDC_all.vcf.gz <span class="kw">|</span> <span class="dt">\</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> +split-vep <span class="at">-d</span> <span class="at">-f</span> <span class="st">'%CHROM\t%POS\t%REF\t%ALT[\t%SAMPLE=%GT]\t%Consequence\t%SYMBOL\n'</span> <span class="op">&gt;</span> CDC_results.txt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>You will have to adapt this to bcftools csq or snpeff.</p>
<p>You can use the <code>split-vep</code> plugin to get a list of the subfields so you can modify the previous command to adapt it to bcftools or snpeff:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode sh code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For SnpEff</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> +split-vep <span class="at">-a</span> ANN <span class="at">-l</span> CDC_all.vcf.gz</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># For bcftools csq</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="ex">bcftools</span> +split-vep <span class="at">-a</span> BCSQ <span class="at">-l</span> CDC_all.vcf.gz</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="task-6-parse-required-information-from-vcf-files" class="level3">
<h3 class="anchored" data-anchor-id="task-6-parse-required-information-from-vcf-files">Task 6: Parse required information from VCF files</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Use any of the options listed above to parse the variant functional annotation from the VCF file.</p>
<ol type="1">
<li>Attach your parsing command to the assignment <strong>(5pts)</strong></li>
</ol>
</div>
</div>
</section>
<section id="task-7-detect-variants-likely-to-be-associated-to-rifampicin-resistance." class="level3">
<h3 class="anchored" data-anchor-id="task-7-detect-variants-likely-to-be-associated-to-rifampicin-resistance.">Task 7: Detect variants likely to be associated to rifampicin resistance.</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Answer the following questions:</p>
<ol type="1">
<li>What criteria does a variant need to meet to be a good candidate for rifampicin resistance in our experiment? <strong>(10pts)</strong></li>
<li>What are the genes with the highest number of variants? <strong>(5pts)</strong></li>
<li>What are the genes with the highest number of non-synoymous variants? In how many samples are these mutations present? <strong>(5pts)</strong></li>
<li>What are the genes with the highest proportion of non-synoymous variants to synonymous variants? <strong>(5pts)</strong></li>
<li>Review the variants within those genes in IGV and determine if the alignment is reliable <strong>(5pts)</strong></li>
<li>What antibiotic resistant mechanism from the ones reviewed in class explains the functional consequence of the variant? (i.e: target site modification, efflux pump, etc.) <strong>(10pts)</strong></li>
</ol>
</div>
</div>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/trgn-515\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>